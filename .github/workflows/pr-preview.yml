# Branch Preview + Regenerate root HTML files when the Mermaid source changes
# -------------------------------------------------------------------------
# Repo layout (repo root):
# - weapons-classification-flowchart.mmd                         (source)
# - classification-guide.html                                    (generated output #1)
# - classification-guide-hypothesis-filtering.html               (generated output #2)
#
# Goals:
# 1) Any time weapons-classification-flowchart.mmd changes on ANY branch:
#    - regenerate BOTH HTML files at the repo root
#    - commit the regenerated HTML back to that SAME branch
# 2) For non-gh-pages branches:
#    - also publish a branch preview to gh-pages under:
#        branch-preview/<branch-name>/
# 3) For gh-pages itself:
#    - do NOT publish a preview folder
#    - just keep the source + generated HTML side-by-side at the root

name: Branch Preview

on:
  push:
    # Run only when the ONE source Mermaid file changes (plus generator/workflow changes).
    # This prevents commit loops because the workflow commits HTML files, not the .mmd.
    paths:
      - "weapons-classification-flowchart.mmd"
      - "src/mermaid_to_clickthrough.py"
      - "src/mermaid_to_hypothesis_filtering.py"
      - ".github/workflows/branch-preview.yml"
      - "classification-guide-hypothesis-filtering.html"
      - "classification-guide.html"

permissions:
  contents: write

concurrency:
  group: branch-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-commit-and-maybe-publish-preview:
    runs-on: ubuntu-latest

    # Extra loop guard: if the actor is GitHub Actions (from our own commit), don't run.
    if: ${{ github.actor != 'github-actions[bot]' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # Generate BOTH HTML outputs at the repo root
      - name: Regenerate classification-guide.html at repo root
        run: |
          python src/mermaid_to_clickthrough.py \
            --input-mmd weapons-classification-flowchart.mmd \
            --output-html classification-guide.html \
            --app-name "[DEMO] Weapons Classification Guide"

      - name: Regenerate classification-guide-hypothesis-filtering.html at repo root
        run: |
          python src/mermaid_to_hypothesis_filtering.py \
            --input-mmd weapons-classification-flowchart.mmd \
            --output-html classification-guide-hypothesis-filtering.html \
            --app-name "[DEMO] Weapons Classification Guide (Hypothesis Filtering)"

      # Commit BOTH regenerated HTML files back to the SAME branch
      - name: Commit regenerated HTML back to the same branch
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage only the generated HTML files (not the whole repo)
          git add classification-guide.html classification-guide-hypothesis-filtering.html

          # If neither file changed, skip committing
          if git diff --cached --quiet; then
            echo "No HTML changes to commit."
            exit 0
          fi

          git commit -m "Regenerate generated HTML outputs [skip ci]"
          git push origin "HEAD:${BRANCH_NAME}"

      # Everything below is ONLY for preview branches (not gh-pages itself)
      - name: Prepare dist/ payload for branch preview publish
        if: ${{ github.ref_name != 'gh-pages' }}
        run: |
          # dist/ is just a publish payload directory (NOT a source-of-truth).
          # Your source + generated HTML remain at the repo root.
          mkdir -p dist

          # Copy both HTML files into the preview payload
          cp classification-guide.html dist/classification-guide.html
          cp classification-guide-hypothesis-filtering.html dist/classification-guide-hypothesis-filtering.html

          # Disable Jekyll processing so GitHub Pages serves files as-is.
          touch dist/.nojekyll

      - name: Publish preview to gh-pages under branch-preview/<branch-name>/
        if: ${{ github.ref_name != 'gh-pages' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: dist
          destination_dir: branch-preview/${{ github.ref_name }}
          enable_jekyll: false
          keep_files: true